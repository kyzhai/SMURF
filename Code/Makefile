TARGET = test

TARGET: ast sast parser scanner test smurf

smurf: parser.cmo scanner.cmo ast.cmo sast.cmo smurf.cmo
	ocamlc -o smurf parser.cmo scanner.cmo ast.cmo sast.cmo smurf.cmo

test: parser.cmo scanner.cmo ast.cmo test.cmo
	ocamlc -o $(TARGET) $^

test.cmo : scanner.cmo parser.cmi ast.cmo
	ocamlc -c test.ml

smurf.cmo: scanner.cmo parser.cmi ast.cmo sast.cmo
	ocamlc -c smurf.ml

scanner.ml: scanner.mll
	ocamllex scanner.mll

ast: ast.ml
	ocamlc -c ast.ml

sast: sast.ml
	ocamlc -c sast.ml

parser.ml parser.mli:  parser.mly
	ocamlyacc -v parser.mly

parser parser.cmo: parser.mli parser.ml ast
	ocamlc -c parser.mli parser.ml

scanner scanner.cmo: scanner.ml
	ocamlc -c scanner.ml

clean:
	rm *.cmi *.cmo parser.ml scanner.ml *.output parser.mli $(TARGET) smurf

TestDir = ./parser-tests
cases = $(shell find $(TestDir) -name "*.sm" | sort)
case = $(cases:%.sm=%)

%: %.sm $(TARGET)
	./$(TARGET) < $<

autotest: $(case) $(TARGET)

# Generated by ocamldep
ast.cmo :
ast.cmx :
sast.cmo :
sast.cmx :
parser.cmo : ast.cmo parser.cmi
parser.cmx : ast.cmx parser.cmi
parser.cmi : ast.cmo
scanner.cmo : parser.cmi
scanner.cmx : parser.cmx
test.cmo : scanner.cmo parser.cmi ast.cmo
test.cmx : scanner.cmx parser.cmx ast.cmx
smurf.cmo : scanner.cmo parser.cmi ast.cmo sast.cmo
smurf.cmx : scanner.cmx parser.cmx ast.cmx sast.cmx
